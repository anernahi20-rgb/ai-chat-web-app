# GitHub Actions workflow for deploying AI Chat Web App to GitHub Pages
name: Deploy AI Chat App to GitHub Pages

on:
  # Triggers the workflow on push to main branch
  push:
    branches: [ main ]
  
  # Allows manual triggering of the workflow
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Build job
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Create package.json if not exists
        run: |
          if [ ! -f package.json ]; then
            echo '{
              "name": "ai-chat-web-app",
              "version": "1.0.0",
              "description": "AI Chat Web Application using Transformers.js",
              "main": "index.html",
              "scripts": {
                "build": "echo Building static site...",
                "serve": "python3 -m http.server 8000"
              },
              "keywords": ["ai", "chat", "transformers", "javascript", "huggingface"],
              "author": "Your Name",
              "license": "MIT",
              "devDependencies": {
                "http-server": "^14.1.1"
              }
            }' > package.json
          fi
          
      - name: Install dependencies
        run: npm install --only=dev
        
      - name: Validate HTML
        run: |
          echo "Validating HTML structure..."
          if ! grep -q "<!DOCTYPE html>" index.html; then
            echo "Warning: Missing DOCTYPE declaration"
          fi
          if ! grep -q "<meta charset=" index.html; then
            echo "Warning: Missing charset declaration"
          fi
          echo "HTML validation completed"
          
      - name: Check JavaScript syntax
        run: |
          echo "Checking JavaScript syntax..."
          node -c script.js
          echo "JavaScript syntax check passed"
          
      - name: Validate CSS
        run: |
          echo "Basic CSS validation..."
          if ! grep -q ":root" style.css; then
            echo "Warning: No CSS custom properties found"
          fi
          echo "CSS validation completed"
          
      - name: Test Transformers.js import
        run: |
          echo "Testing Transformers.js CDN availability..."
          curl -f -s "https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2/dist/transformers.min.js" > /dev/null
          echo "Transformers.js CDN is accessible"
          
      - name: Create build directory
        run: |
          mkdir -p _site
          cp -r * _site/ 2>/dev/null || true
          # Remove hidden files that shouldn't be deployed
          rm -rf _site/.git* _site/.github 2>/dev/null || true
          # Create a simple manifest for PWA functionality
          echo '{
            "name": "AI Chat Assistant",
            "short_name": "AI Chat",
            "description": "AI Chat powered by Transformers.js",
            "start_url": "./",
            "display": "standalone",
            "background_color": "#667eea",
            "theme_color": "#667eea",
            "icons": [
              {
                "src": "https://via.placeholder.com/192x192/667eea/ffffff?text=AI",
                "sizes": "192x192",
                "type": "image/png"
              },
              {
                "src": "https://via.placeholder.com/512x512/667eea/ffffff?text=AI",
                "sizes": "512x512",
                "type": "image/png"
              }
            ]
          }' > _site/manifest.json
          
      - name: Add PWA meta tags
        run: |
          # Add PWA manifest link to HTML if not present
          if ! grep -q "manifest.json" _site/index.html; then
            sed -i 's|</head>|    <link rel="manifest" href="./manifest.json">\n    <meta name="theme-color" content="#667eea">\n    <meta name="apple-mobile-web-app-capable" content="yes">\n    <meta name="apple-mobile-web-app-status-bar-style" content="default">\n    <meta name="apple-mobile-web-app-title" content="AI Chat">\n</head>|' _site/index.html
          fi
          
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'
          
  # Deployment job
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
      - name: Display deployment URL
        run: |
          echo "ðŸš€ AI Chat Web App has been deployed!"
          echo "ðŸ“± Access your app at: ${{ steps.deployment.outputs.page_url }}"
          echo "âœ¨ Features:"
          echo "   â€¢ Client-side AI using Transformers.js"
          echo "   â€¢ No API keys required"
          echo "   â€¢ Multiple model options"
          echo "   â€¢ Works offline after first load"
          echo "   â€¢ Mobile responsive design"
          
      - name: Create deployment summary
        run: |
          echo "## ðŸ¤– AI Chat Web App Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Deployment Status**: Successful" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **Live URL**: [${{ steps.deployment.outputs.page_url }}](${{ steps.deployment.outputs.page_url }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Key Features" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ§  **Client-side AI**: Powered by Transformers.js" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” **Privacy First**: No data sent to servers" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸš« **No API Keys**: Completely free to use" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“± **Responsive**: Works on all devices" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŒ **Offline Ready**: Works without internet after first load" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ¤– Available Models" >> $GITHUB_STEP_SUMMARY
          echo "- **DistilGPT-2** (82MB) - Fast and lightweight" >> $GITHUB_STEP_SUMMARY
          echo "- **GPT-2** (548MB) - Better quality responses" >> $GITHUB_STEP_SUMMARY
          echo "- **SmolLM-135M** (268MB) - Instruction-tuned" >> $GITHUB_STEP_SUMMARY
          echo "- **DialoGPT-Small** (117MB) - Chat optimized" >> $GITHUB_STEP_SUMMARY